# MD.AI 技术方案

## 1. 项目概述

### 1.1 目标
构建一个类似 Typora 的 Markdown 查看/编辑软件，支持：
- 多平台运行（macOS/Windows/Linux/Web）
- 微信公众号排版主题
- 数学公式、Mermaid 图表
- 图片处理与存储
- 自定义字体和主题

### 1.2 参考项目
- [md2wechat](https://www.md2wechat.com/)
- [mmdeditor](https://mmdeditor.boxtech.icu/)
- [wechat.jeffjade](https://wechat.jeffjade.com/)
- [doocs/md](https://github.com/doocs/md) - 开源微信 Markdown 编辑器

---

## 2. 技术选型

### 2.1 方案对比

| 方案 | 开发时间 | 跨平台 | 主题定制 | 复杂度 | 推荐度 |
|------|---------|--------|---------|--------|--------|
| VSCode 扩展 | 1-2周 | ✅ | ⚠️ 有限 | 低 | ⭐⭐ |
| Web 应用 | 1-2周 | ✅ 浏览器 | ✅ 完全 | 低 | ⭐⭐⭐⭐ |
| Electron 桌面 | 2-3周 | ✅ | ✅ 完全 | 中 | ⭐⭐⭐ |
| Tauri 桌面 | 2-3周 | ✅ | ✅ 完全 | 中 | ⭐⭐⭐⭐⭐ |

### 2.2 推荐方案：Web + Tauri

**阶段一**：先做 Web 版本（快速验证）
**阶段二**：使用 Tauri 封装成桌面应用

**选择 Tauri 的理由**：
- 比 Electron 体积小 10 倍以上
- 性能更好，内存占用低
- 原生系统 API 支持好
- Rust 后端安全可靠

### 2.3 技术栈

```
前端框架: React 19 + TypeScript
构建工具: Vite 7
编辑器:   CodeMirror 6 或 Monaco Editor
Markdown: marked.js / markdown-it
公式渲染: KaTeX
图表渲染: Mermaid
桌面封装: Tauri 2.0
```

---

## 3. 核心功能模块

### 3.1 功能优先级

#### P0 - 核心功能（必须）
- [ ] Markdown 编辑器（语法高亮）
- [ ] 实时预览
- [ ] 主题切换
- [ ] 字体配置
- [ ] 数学公式（KaTeX）
- [ ] Mermaid 图表
- [ ] 图片粘贴/拖拽插入

#### P1 - 重要功能
- [ ] 图片本地存储
- [ ] 图床上传（GitHub/SM.MS/七牛云）
- [ ] 文件管理（打开/保存）
- [ ] 快捷键支持
- [ ] 大纲导航

#### P2 - 低优先级
- [ ] 微信公众号一键复制
- [ ] 图片批量导出
- [ ] PDF 导出
- [ ] HTML 导出
- [ ] 多标签页

---

## 4. 项目结构

```
md.ai/
├── docs/                      # 文档
│   └── 技术方案.md
├── src/
│   ├── components/            # React 组件
│   │   ├── Editor/            # 编辑器组件
│   │   │   ├── Editor.tsx
│   │   │   ├── EditorToolbar.tsx
│   │   │   └── index.ts
│   │   ├── Preview/           # 预览组件
│   │   │   ├── Preview.tsx
│   │   │   ├── MathRenderer.tsx
│   │   │   ├── MermaidRenderer.tsx
│   │   │   └── index.ts
│   │   ├── ThemeSelector/     # 主题选择
│   │   ├── FontConfig/        # 字体配置
│   │   └── ImageUploader/     # 图片上传
│   ├── themes/                # 主题样式
│   │   ├── base.css           # 基础变量
│   │   ├── wechat-default.css
│   │   ├── wechat-elegant.css
│   │   ├── github.css
│   │   └── index.ts
│   ├── fonts/                 # 字体定义
│   │   └── font-config.ts
│   ├── lib/                   # 工具库
│   │   ├── markdown.ts        # Markdown 解析
│   │   ├── math.ts            # 公式处理
│   │   ├── mermaid.ts         # 图表处理
│   │   └── image.ts           # 图片处理
│   ├── stores/                # 状态管理
│   │   ├── editor.ts          # 编辑器状态
│   │   └── settings.ts        # 用户设置
│   ├── hooks/                 # 自定义 Hooks
│   ├── types/                 # TypeScript 类型
│   ├── App.tsx
│   ├── App.css
│   └── main.tsx
├── public/
├── src-tauri/                 # Tauri 后端（阶段二）
├── package.json
├── vite.config.ts
├── tsconfig.json
└── README.md
```

---

## 5. 详细设计

### 5.1 Markdown 解析

使用 `marked.js` + 自定义扩展：

```typescript
// lib/markdown.ts
import { marked } from 'marked';
import { markedHighlight } from 'marked-highlight';
import hljs from 'highlight.js';

// 配置代码高亮
marked.use(markedHighlight({
  langPrefix: 'hljs language-',
  highlight(code, lang) {
    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
    return hljs.highlight(code, { language }).value;
  }
}));

// 自定义渲染器
const renderer = new marked.Renderer();

// 自定义图片渲染（支持尺寸控制）
renderer.image = (href, title, text) => {
  return `<img src="${href}" alt="${text}" title="${title || ''}" loading="lazy" />`;
};

export function parseMarkdown(content: string): string {
  return marked(content, { renderer });
}
```

### 5.2 数学公式（KaTeX）

```typescript
// lib/math.ts
import katex from 'katex';
import 'katex/dist/katex.min.css';

// 行内公式正则: $...$
const INLINE_MATH_REGEX = /\$([^\$]+)\$/g;

// 块级公式正则: $$...$$
const BLOCK_MATH_REGEX = /\$\$([^\$]+)\$\$/g;

export function renderMath(html: string): string {
  // 渲染块级公式
  html = html.replace(BLOCK_MATH_REGEX, (_, tex) => {
    try {
      return katex.renderToString(tex.trim(), {
        displayMode: true,
        throwOnError: false
      });
    } catch (e) {
      return `<span class="math-error">${tex}</span>`;
    }
  });

  // 渲染行内公式
  html = html.replace(INLINE_MATH_REGEX, (_, tex) => {
    try {
      return katex.renderToString(tex.trim(), {
        displayMode: false,
        throwOnError: false
      });
    } catch (e) {
      return `<span class="math-error">${tex}</span>`;
    }
  });

  return html;
}
```

### 5.3 Mermaid 图表

```typescript
// lib/mermaid.ts
import mermaid from 'mermaid';

mermaid.initialize({
  startOnLoad: false,
  theme: 'default',
  securityLevel: 'loose',
  fontFamily: 'var(--font-sans)'
});

let mermaidId = 0;

export async function renderMermaid(code: string): Promise<string> {
  const id = `mermaid-${mermaidId++}`;
  try {
    const { svg } = await mermaid.render(id, code);
    return `<div class="mermaid-container">${svg}</div>`;
  } catch (e) {
    return `<div class="mermaid-error">图表渲染错误: ${e}</div>`;
  }
}
```

### 5.4 主题系统

#### 基础变量定义

```css
/* themes/base.css */
:root {
  /* ===== 字体 ===== */
  --font-sans: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
  --font-serif: "Source Han Serif SC", "Noto Serif SC", "Songti SC", serif;
  --font-mono: "JetBrains Mono", "Fira Code", "SF Mono", Consolas, monospace;
  
  /* ===== 字号 ===== */
  --font-size-base: 16px;
  --font-size-sm: 14px;
  --font-size-lg: 18px;
  --font-size-h1: 2em;
  --font-size-h2: 1.5em;
  --font-size-h3: 1.25em;
  --font-size-h4: 1em;
  --font-size-code: 0.9em;
  
  /* ===== 行高 ===== */
  --line-height: 1.8;
  --line-height-heading: 1.4;
  --line-height-code: 1.5;
  
  /* ===== 间距 ===== */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  
  /* ===== 颜色（主题覆盖） ===== */
  --color-text: #333;
  --color-text-secondary: #666;
  --color-text-muted: #999;
  --color-bg: #fff;
  --color-bg-code: #f6f8fa;
  --color-border: #e1e4e8;
  --color-link: #0366d6;
  --color-accent: #0366d6;
}
```

#### 微信主题示例

```css
/* themes/wechat-elegant.css */
.theme-wechat-elegant {
  --font-sans: "Optima-Regular", "PingFang SC", sans-serif;
  --color-text: #3f3f3f;
  --color-accent: #ff6827;
  --color-bg-code: #fff5f5;
}

.theme-wechat-elegant .markdown-body {
  padding: 20px;
  max-width: 780px;
  margin: 0 auto;
}

.theme-wechat-elegant h1 {
  text-align: center;
  font-weight: bold;
  border-bottom: 2px solid var(--color-accent);
  padding-bottom: 10px;
}

.theme-wechat-elegant h2 {
  display: inline-block;
  font-weight: bold;
  background: var(--color-accent);
  color: #fff;
  padding: 2px 10px;
  border-radius: 3px;
  margin: 20px 0 10px;
}

.theme-wechat-elegant blockquote {
  border-left: 3px solid var(--color-accent);
  padding-left: 15px;
  color: var(--color-text-secondary);
  background: #f7f7f7;
  margin: 15px 0;
  padding: 10px 15px;
}

.theme-wechat-elegant code {
  background: var(--color-bg-code);
  color: #c7254e;
  padding: 2px 6px;
  border-radius: 3px;
}

.theme-wechat-elegant pre {
  background: #282c34;
  border-radius: 5px;
  padding: 15px;
  overflow-x: auto;
}

.theme-wechat-elegant pre code {
  background: transparent;
  color: #abb2bf;
  padding: 0;
}
```

### 5.5 字体配置系统

```typescript
// fonts/font-config.ts
export interface FontConfig {
  id: string;
  name: string;
  family: string;
  fallback: string[];
  webFont?: {
    url: string;
    format: 'woff2' | 'woff' | 'ttf';
  };
}

export const FONT_PRESETS: FontConfig[] = [
  {
    id: 'system-sans',
    name: '系统无衬线',
    family: 'system-ui',
    fallback: ['-apple-system', 'Segoe UI', 'Roboto', 'sans-serif']
  },
  {
    id: 'pingfang',
    name: '苹方',
    family: 'PingFang SC',
    fallback: ['Microsoft YaHei', 'sans-serif']
  },
  {
    id: 'source-han-serif',
    name: '思源宋体',
    family: 'Source Han Serif SC',
    fallback: ['Noto Serif SC', 'serif']
  },
  {
    id: 'jetbrains-mono',
    name: 'JetBrains Mono',
    family: 'JetBrains Mono',
    fallback: ['Fira Code', 'Consolas', 'monospace'],
    webFont: {
      url: 'https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap',
      format: 'woff2'
    }
  }
];

export function buildFontFamily(config: FontConfig): string {
  return [config.family, ...config.fallback].map(f => 
    f.includes(' ') ? `"${f}"` : f
  ).join(', ');
}
```

### 5.6 图片处理

```typescript
// lib/image.ts
export type ImageStorageStrategy = 'base64' | 'local' | 'cloud';

export interface ImageConfig {
  strategy: ImageStorageStrategy;
  maxSize?: number;        // 最大文件大小 (bytes)
  quality?: number;        // 压缩质量 0-1
  localPath?: string;      // 本地存储路径
  cloudProvider?: string;  // 云存储提供商
}

// 将文件转为 Base64
export function fileToBase64(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result as string);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// 处理粘贴的图片
export async function handlePastedImage(
  event: ClipboardEvent,
  config: ImageConfig
): Promise<string | null> {
  const items = event.clipboardData?.items;
  if (!items) return null;

  for (const item of items) {
    if (item.type.startsWith('image/')) {
      const file = item.getAsFile();
      if (!file) continue;

      switch (config.strategy) {
        case 'base64':
          return await fileToBase64(file);
        case 'local':
          // 需要 Tauri 后端支持
          return await saveToLocal(file, config.localPath!);
        case 'cloud':
          return await uploadToCloud(file, config.cloudProvider!);
      }
    }
  }
  return null;
}

// 插入 Markdown 图片语法
export function insertImageMarkdown(url: string, alt: string = 'image'): string {
  return `![${alt}](${url})`;
}
```

---

## 6. 依赖列表

```json
{
  "dependencies": {
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    
    "marked": "^12.0.0",
    "marked-highlight": "^2.1.0",
    "highlight.js": "^11.9.0",
    
    "katex": "^0.16.9",
    "mermaid": "^10.6.0",
    
    "@codemirror/lang-markdown": "^6.2.0",
    "@codemirror/state": "^6.4.0",
    "@codemirror/view": "^6.22.0",
    "@codemirror/commands": "^6.3.0",
    
    "zustand": "^4.5.0"
  },
  "devDependencies": {
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "typescript": "~5.9.3",
    "vite": "^7.2.4",
    "@tauri-apps/cli": "^2.0.0"
  }
}
```

---

## 7. 开发计划

### 第一阶段：Web 核心功能（1-2周）

| 任务 | 预计时间 | 优先级 |
|-----|---------|--------|
| 搭建项目框架 | 1天 | P0 |
| 集成 CodeMirror 编辑器 | 2天 | P0 |
| 实现 Markdown 实时预览 | 1天 | P0 |
| 实现主题系统 | 2天 | P0 |
| 集成 KaTeX 公式 | 1天 | P0 |
| 集成 Mermaid 图表 | 1天 | P0 |
| 图片粘贴（Base64） | 1天 | P0 |
| 字体配置面板 | 1天 | P0 |

### 第二阶段：完善功能（1周）

| 任务 | 预计时间 | 优先级 |
|-----|---------|--------|
| 添加更多微信主题 | 2天 | P1 |
| 图床上传支持 | 2天 | P1 |
| 文件打开/保存 | 1天 | P1 |
| 快捷键系统 | 1天 | P1 |
| 大纲导航 | 1天 | P1 |

### 第三阶段：桌面应用（1周）

| 任务 | 预计时间 | 优先级 |
|-----|---------|--------|
| 集成 Tauri | 1天 | P1 |
| 本地文件系统 | 2天 | P1 |
| 图片本地存储 | 1天 | P1 |
| 打包发布 | 1天 | P1 |

### 第四阶段：低优先级功能

| 任务 | 优先级 |
|-----|--------|
| 微信公众号一键复制 | P2 |
| 图片批量导出 | P2 |
| PDF 导出 | P2 |
| 多标签页 | P2 |

---

## 8. 参考资源

### 开源项目
- [doocs/md](https://github.com/doocs/md) - 微信 Markdown 编辑器
- [Typora](https://typora.io/) - 功能参考
- [MarkText](https://github.com/marktext/marktext) - Electron 实现参考

### 文档
- [marked.js 文档](https://marked.js.org/)
- [KaTeX 文档](https://katex.org/docs/api.html)
- [Mermaid 文档](https://mermaid.js.org/)
- [CodeMirror 6 文档](https://codemirror.net/docs/)
- [Tauri 文档](https://tauri.app/zh-cn/)

### 字体资源
- [Google Fonts](https://fonts.google.com/)
- [思源字体](https://github.com/adobe-fonts/source-han-sans)
